<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary Quest ‚Äì ‰∏≠Ëã±ÂçïËØçÁªÉ‰π†Ê∏∏Êàè</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        #app {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 500px;
            min-height: 600px;
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .screen {
            display: none;
            width: 100%;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .screen.active {
            display: flex;
        }

        h1 {
            font-size: 28px;
            color: #333;
            margin-bottom: 10px;
        }

        h2 {
            font-size: 22px;
            color: #555;
            margin-bottom: 20px;
        }

        .subtitle {
            font-size: 16px;
            color: #666;
            margin-bottom: 30px;
        }

        .mode-btn {
            width: 100%;
            padding: 20px;
            margin: 10px 0;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .mode-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .mode-btn:active {
            transform: translateY(0);
        }

        .mode-btn.eng-chi {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .mode-btn.chi-eng {
            background: linear-gradient(135deg, #fc4a1a 0%, #f7b733 100%);
            color: white;
        }

        .mode-btn.flashcard {
            background: linear-gradient(135deg, #5f2c82 0%, #49a09d 100%);
            color: white;
        }

        .mode-btn.paragraph {
            background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
            color: white;
        }

        /* Quiz Screen Styles */
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #11998e, #38ef7d);
            border-radius: 5px;
            transition: width 0.3s ease;
        }

        .score-display {
            font-size: 18px;
            color: #666;
            margin-bottom: 20px;
        }

        .question-word {
            font-size: 36px;
            font-weight: bold;
            color: #333;
            margin: 30px 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            width: 100%;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .question-word:hover {
            transform: scale(1.02);
        }

        .question-word.speakable::after {
            content: ' üîä';
            font-size: 24px;
        }

        .answer-btn {
            width: 100%;
            padding: 18px;
            margin: 8px 0;
            font-size: 18px;
            border: 2px solid #ddd;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .answer-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .answer-btn.correct {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .answer-btn.wrong {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .answer-btn:disabled {
            cursor: not-allowed;
        }

        .feedback {
            font-size: 24px;
            margin: 20px 0;
            min-height: 40px;
        }

        /* Flashcard Styles */
        .flashcard-container {
            perspective: 1000px;
            width: 100%;
            height: 250px;
            margin: 30px 0;
        }

        .flashcard {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
        }

        .flashcard.flipped {
            transform: rotateY(180deg);
        }

        .flashcard-front,
        .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 32px;
            font-weight: bold;
            border-radius: 20px;
            padding: 20px;
        }

        .flashcard-front {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .flashcard-back {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            transform: rotateY(180deg);
        }

        .flashcard-nav {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .nav-btn {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-btn.prev {
            background: #6c757d;
            color: white;
        }

        .nav-btn.next {
            background: #007bff;
            color: white;
        }

        .nav-btn:hover {
            transform: scale(1.05);
        }

        .card-counter {
            font-size: 18px;
            color: #666;
            margin-top: 15px;
        }

        .tap-hint {
            font-size: 14px;
            color: #999;
            margin-top: 10px;
        }

        /* Results Screen */
        .result-score {
            font-size: 72px;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
        }

        .result-text {
            font-size: 24px;
            color: #333;
            margin-bottom: 30px;
        }

        .result-message {
            font-size: 18px;
            color: #666;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .restart-btn {
            padding: 18px 40px;
            font-size: 18px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .restart-btn:hover {
            transform: scale(1.05);
        }

        .home-btn {
            margin-top: 15px;
            padding: 12px 30px;
            font-size: 16px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .home-btn:hover {
            background: #5a6268;
        }

        /* Paragraph Fill Game Styles */
        .paragraph-container {
            width: 100%;
            text-align: left;
            margin: 20px 0;
        }

        .paragraph-text {
            font-size: 18px;
            line-height: 2;
            color: #333;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .blank {
            display: inline-block;
            min-width: 120px;
            padding: 5px 15px;
            margin: 0 5px;
            border-bottom: 3px solid #667eea;
            background: #e8ecff;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            color: #667eea;
            transition: all 0.3s;
        }

        .blank.active {
            background: #667eea;
            color: white;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
            animation: pulse 1.5s infinite;
        }

        .blank.filled {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .blank.wrong {
            animation: shake 0.5s;
            background: #f8d7da;
            border-color: #dc3545;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 10px rgba(102, 126, 234, 0.5); }
            50% { box-shadow: 0 0 20px rgba(102, 126, 234, 0.8); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        .word-choices {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .word-btn {
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            border: 2px solid #667eea;
            border-radius: 25px;
            background: white;
            color: #667eea;
            cursor: pointer;
            transition: all 0.2s;
        }

        .word-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.05);
        }

        .word-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .word-btn.used {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .paragraph-feedback {
            font-size: 20px;
            font-weight: bold;
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .paragraph-feedback.success {
            background: #d4edda;
            color: #155724;
        }

        .paragraph-score {
            font-size: 18px;
            color: #666;
            margin-bottom: 15px;
        }

        /* Responsive */
        @media (max-width: 480px) {
            #app {
                padding: 20px;
                min-height: auto;
            }

            h1 {
                font-size: 24px;
            }

            .question-word {
                font-size: 28px;
            }

            .flashcard-front,
            .flashcard-back {
                font-size: 26px;
            }

            .result-score {
                font-size: 56px;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Start Screen -->
        <div id="start-screen" class="screen active">
            <h1>Vocabulary Quest</h1>
            <p class="subtitle">‰∏≠Ëã±ÂåªÂ≠¶ÂçïËØçÁªÉ‰π†Ê∏∏Êàè</p>
            <h2>ÈÄâÊã©Ê∏∏ÊàèÊ®°Âºè</h2>
            <button class="mode-btn eng-chi" onclick="startQuiz('eng-chi')">
                Mode A: English ‚Üí ‰∏≠Êñá
            </button>
            <button class="mode-btn chi-eng" onclick="startQuiz('chi-eng')">
                Mode B: ‰∏≠Êñá ‚Üí English
            </button>
            <button class="mode-btn flashcard" onclick="startFlashcards()">
                Mode C: Flashcards ÂçïËØçÂç°Áâá
            </button>
            <button class="mode-btn paragraph" onclick="startParagraph()">
                Mode D: Paragraph Fill ÊÆµËêΩÂ°´Á©∫
            </button>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="screen">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="score-display">
                Score: <span id="score">0</span> / <span id="total">0</span>
            </div>
            <div class="question-word" id="question-word" onclick="speakQuestionWord()"></div>
            <div id="answers-container">
                <button class="answer-btn" onclick="checkAnswer(0)"></button>
                <button class="answer-btn" onclick="checkAnswer(1)"></button>
                <button class="answer-btn" onclick="checkAnswer(2)"></button>
                <button class="answer-btn" onclick="checkAnswer(3)"></button>
            </div>
            <div class="feedback" id="feedback"></div>
        </div>

        <!-- Flashcard Screen -->
        <div id="flashcard-screen" class="screen">
            <h2>Flashcards ÂçïËØçÂç°Áâá</h2>
            <div class="flashcard-container">
                <div class="flashcard" id="flashcard" onclick="flipCard()">
                    <div class="flashcard-front" id="card-front"></div>
                    <div class="flashcard-back" id="card-back"></div>
                </div>
            </div>
            <p class="tap-hint">ÁÇπÂáªÂç°ÁâáÁøªËΩ¨ / Tap to flip</p>
            <div class="card-counter">
                <span id="card-index">1</span> / <span id="card-total">100</span>
            </div>
            <div class="flashcard-nav">
                <button class="nav-btn prev" onclick="prevCard()">‚Üê Previous</button>
                <button class="nav-btn next" onclick="nextCard()">Next ‚Üí</button>
            </div>
            <button class="home-btn" onclick="goHome()">ËøîÂõû‰∏ªÈ°µ</button>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="screen">
            <h2>Game Over!</h2>
            <div class="result-score" id="final-score">0</div>
            <div class="result-text">out of 20 questions</div>
            <div class="result-message" id="result-message"></div>
            <button class="restart-btn" onclick="restartQuiz()">Play Again</button>
            <button class="home-btn" onclick="goHome()">ËøîÂõû‰∏ªÈ°µ</button>
        </div>

        <!-- Paragraph Fill Screen -->
        <div id="paragraph-screen" class="screen">
            <h2>Paragraph Fill ÊÆµËêΩÂ°´Á©∫</h2>
            <div class="paragraph-score">
                Completed: <span id="para-score">0</span> paragraphs
            </div>
            <div class="paragraph-container">
                <div class="paragraph-text" id="paragraph-text"></div>
            </div>
            <div class="word-choices" id="word-choices"></div>
            <div class="paragraph-feedback" id="para-feedback"></div>
            <button class="home-btn" onclick="goHome()">ËøîÂõû‰∏ªÈ°µ</button>
        </div>
    </div>

    <script>
        // Medical vocabulary data - 100 terms
        const medicalWords = [
            { english: "hypertension", chinese: "È´òË°ÄÂéã" },
            { english: "diabetes", chinese: "Á≥ñÂ∞øÁóÖ" },
            { english: "pneumonia", chinese: "ËÇ∫ÁÇé" },
            { english: "bronchitis", chinese: "ÊîØÊ∞îÁÆ°ÁÇé" },
            { english: "arthritis", chinese: "ÂÖ≥ËäÇÁÇé" },
            { english: "anemia", chinese: "Ë¥´Ë°Ä" },
            { english: "asthma", chinese: "ÂìÆÂñò" },
            { english: "migraine", chinese: "ÂÅèÂ§¥Áóõ" },
            { english: "insomnia", chinese: "Â§±Áú†" },
            { english: "obesity", chinese: "ËÇ•ËÉñÁóá" },
            { english: "fracture", chinese: "È™®Êäò" },
            { english: "infection", chinese: "ÊÑüÊüì" },
            { english: "inflammation", chinese: "ÁÇéÁóá" },
            { english: "tumor", chinese: "ËÇøÁò§" },
            { english: "cancer", chinese: "ÁôåÁóá" },
            { english: "leukemia", chinese: "ÁôΩË°ÄÁóÖ" },
            { english: "hepatitis", chinese: "ËÇùÁÇé" },
            { english: "gastritis", chinese: "ËÉÉÁÇé" },
            { english: "appendicitis", chinese: "ÈòëÂ∞æÁÇé" },
            { english: "tonsillitis", chinese: "ÊâÅÊ°É‰ΩìÁÇé" },
            { english: "meningitis", chinese: "ËÑëËÜúÁÇé" },
            { english: "dermatitis", chinese: "ÁöÆÁÇé" },
            { english: "conjunctivitis", chinese: "ÁªìËÜúÁÇé" },
            { english: "otitis", chinese: "ËÄ≥ÁÇé" },
            { english: "sinusitis", chinese: "ÈºªÁ™¶ÁÇé" },
            { english: "pharyngitis", chinese: "ÂíΩÁÇé" },
            { english: "laryngitis", chinese: "ÂñâÁÇé" },
            { english: "nephritis", chinese: "ËÇæÁÇé" },
            { english: "cystitis", chinese: "ËÜÄËÉ±ÁÇé" },
            { english: "prostatitis", chinese: "ÂâçÂàóËÖ∫ÁÇé" },
            { english: "endometritis", chinese: "Â≠êÂÆ´ÂÜÖËÜúÁÇé" },
            { english: "mastitis", chinese: "‰π≥ËÖ∫ÁÇé" },
            { english: "pancreatitis", chinese: "ËÉ∞ËÖ∫ÁÇé" },
            { english: "cholecystitis", chinese: "ËÉÜÂõäÁÇé" },
            { english: "peritonitis", chinese: "ËÖπËÜúÁÇé" },
            { english: "myocarditis", chinese: "ÂøÉËÇåÁÇé" },
            { english: "pericarditis", chinese: "ÂøÉÂåÖÁÇé" },
            { english: "endocarditis", chinese: "ÂøÉÂÜÖËÜúÁÇé" },
            { english: "thrombosis", chinese: "Ë°ÄÊ†ìÂΩ¢Êàê" },
            { english: "embolism", chinese: "Ê†ìÂ°û" },
            { english: "hemorrhage", chinese: "Âá∫Ë°Ä" },
            { english: "edema", chinese: "Ê∞¥ËÇø" },
            { english: "necrosis", chinese: "ÂùèÊ≠ª" },
            { english: "fibrosis", chinese: "Á∫§Áª¥Âåñ" },
            { english: "cirrhosis", chinese: "ËÇùÁ°¨Âåñ" },
            { english: "atherosclerosis", chinese: "Âä®ËÑâÁ≤•Ê†∑Á°¨Âåñ" },
            { english: "osteoporosis", chinese: "È™®Ë¥®ÁñèÊùæÁóá" },
            { english: "scoliosis", chinese: "ËÑäÊü±‰æßÂºØ" },
            { english: "epilepsy", chinese: "Áô´Áó´" },
            { english: "paralysis", chinese: "Áò´Áó™" },
            { english: "stroke", chinese: "‰∏≠È£é" },
            { english: "concussion", chinese: "ËÑëÈúáËç°" },
            { english: "hernia", chinese: "ÁñùÊ∞î" },
            { english: "ulcer", chinese: "Ê∫ÉÁñ°" },
            { english: "abscess", chinese: "ËÑìËÇø" },
            { english: "cyst", chinese: "ÂõäËÇø" },
            { english: "polyp", chinese: "ÊÅØËÇâ" },
            { english: "nodule", chinese: "ÁªìËäÇ" },
            { english: "lesion", chinese: "ÁóÖÂèò" },
            { english: "symptom", chinese: "ÁóáÁä∂" },
            { english: "diagnosis", chinese: "ËØäÊñ≠" },
            { english: "prognosis", chinese: "È¢ÑÂêé" },
            { english: "therapy", chinese: "Ê≤ªÁñó" },
            { english: "surgery", chinese: "ÊâãÊúØ" },
            { english: "biopsy", chinese: "Ê¥ªÊ£Ä" },
            { english: "autopsy", chinese: "Â∞∏Ê£Ä" },
            { english: "prescription", chinese: "Â§ÑÊñπ" },
            { english: "dosage", chinese: "ÂâÇÈáè" },
            { english: "injection", chinese: "Ê≥®Â∞Ñ" },
            { english: "infusion", chinese: "ËæìÊ∂≤" },
            { english: "transfusion", chinese: "ËæìË°Ä" },
            { english: "anesthesia", chinese: "È∫ªÈÜâ" },
            { english: "antibiotic", chinese: "ÊäóÁîüÁ¥†" },
            { english: "vaccine", chinese: "Áñ´Ëãó" },
            { english: "immunity", chinese: "ÂÖçÁñ´Âäõ" },
            { english: "allergy", chinese: "ËøáÊïè" },
            { english: "metabolism", chinese: "Êñ∞Èôà‰ª£Ë∞¢" },
            { english: "hormone", chinese: "ÊøÄÁ¥†" },
            { english: "enzyme", chinese: "ÈÖ∂" },
            { english: "protein", chinese: "ËõãÁôΩË¥®" },
            { english: "carbohydrate", chinese: "Á¢≥Ê∞¥ÂåñÂêàÁâ©" },
            { english: "cholesterol", chinese: "ËÉÜÂõ∫ÈÜá" },
            { english: "glucose", chinese: "Ëë°ËêÑÁ≥ñ" },
            { english: "hemoglobin", chinese: "Ë°ÄÁ∫¢ËõãÁôΩ" },
            { english: "platelet", chinese: "Ë°ÄÂ∞èÊùø" },
            { english: "leukocyte", chinese: "ÁôΩÁªÜËÉû" },
            { english: "erythrocyte", chinese: "Á∫¢ÁªÜËÉû" },
            { english: "artery", chinese: "Âä®ËÑâ" },
            { english: "vein", chinese: "ÈùôËÑâ" },
            { english: "capillary", chinese: "ÊØõÁªÜË°ÄÁÆ°" },
            { english: "nerve", chinese: "Á•ûÁªè" },
            { english: "muscle", chinese: "ËÇåËÇâ" },
            { english: "tendon", chinese: "ËÇåËÖ±" },
            { english: "ligament", chinese: "ÈüßÂ∏¶" },
            { english: "cartilage", chinese: "ËΩØÈ™®" },
            { english: "bone marrow", chinese: "È™®È´ì" },
            { english: "spleen", chinese: "ËÑæËÑè" },
            { english: "thyroid", chinese: "Áî≤Áä∂ËÖ∫" },
            { english: "adrenal gland", chinese: "ËÇæ‰∏äËÖ∫" },
            { english: "pituitary gland", chinese: "ÂûÇ‰Ωì" }
        ];

        // Game state
        let currentMode = '';
        let currentQuestionIndex = 0;
        let score = 0;
        let totalQuestions = 20;
        let currentAnswers = [];
        let correctAnswerIndex = 0;
        let shuffledWords = [];
        let currentCardIndex = 0;
        let isAnswered = false;
        let speechEnabled = false;
        let pendingSpeech = null;

        // Initialize speech synthesis after user interaction
        function initSpeech() {
            if (!speechEnabled && 'speechSynthesis' in window) {
                // Unlock audio context with a silent utterance
                const unlock = new SpeechSynthesisUtterance('');
                unlock.volume = 0;
                window.speechSynthesis.speak(unlock);
                speechEnabled = true;

                // Speak any pending word
                if (pendingSpeech) {
                    setTimeout(() => {
                        speakWord(pendingSpeech);
                        pendingSpeech = null;
                    }, 100);
                }
            }
        }

        // Speech synthesis function
        function speakWord(text) {
            if ('speechSynthesis' in window) {
                // Cancel any ongoing speech
                window.speechSynthesis.cancel();

                // If speech not yet enabled, queue it
                if (!speechEnabled) {
                    pendingSpeech = text;
                    return;
                }

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 0.9;
                utterance.pitch = 1;

                // Fix for some browsers where voices aren't loaded yet
                const voices = window.speechSynthesis.getVoices();
                const englishVoice = voices.find(v => v.lang.startsWith('en'));
                if (englishVoice) {
                    utterance.voice = englishVoice;
                }

                window.speechSynthesis.speak(utterance);
            }
        }

        // Preload voices when available
        if ('speechSynthesis' in window) {
            window.speechSynthesis.onvoiceschanged = function() {
                window.speechSynthesis.getVoices();
            };
        }

        // Speak current question word (for clicking on question in quiz mode)
        function speakQuestionWord() {
            if (currentMode === 'eng-chi' && shuffledWords[currentQuestionIndex]) {
                speakWord(shuffledWords[currentQuestionIndex].english);
            }
        }

        // Utility functions
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // Quiz functions
        function startQuiz(mode) {
            // Initialize speech on user interaction (button click)
            initSpeech();

            currentMode = mode;
            currentQuestionIndex = 0;
            score = 0;
            shuffledWords = shuffleArray(medicalWords).slice(0, totalQuestions);

            document.getElementById('score').textContent = '0';
            document.getElementById('total').textContent = '0';
            document.getElementById('feedback').textContent = '';

            showScreen('quiz-screen');

            // Small delay to ensure speech is initialized before first word
            setTimeout(() => {
                loadQuestion();
            }, 150);
        }

        function loadQuestion() {
            if (currentQuestionIndex >= totalQuestions) {
                showResults();
                return;
            }

            isAnswered = false;
            const currentWord = shuffledWords[currentQuestionIndex];

            // Update progress
            const progress = ((currentQuestionIndex) / totalQuestions) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';

            // Set question word
            const questionWord = currentMode === 'eng-chi' ? currentWord.english : currentWord.chinese;
            document.getElementById('question-word').textContent = questionWord;

            // Add speakable class and speak the word if it's English (Mode A: English ‚Üí Chinese)
            const questionWordEl = document.getElementById('question-word');
            if (currentMode === 'eng-chi') {
                questionWordEl.classList.add('speakable');
                speakWord(currentWord.english);
            } else {
                questionWordEl.classList.remove('speakable');
            }

            // Generate answer choices
            const correctAnswer = currentMode === 'eng-chi' ? currentWord.chinese : currentWord.english;

            // Get 3 random wrong answers
            let wrongAnswers = medicalWords
                .filter(w => w !== currentWord)
                .sort(() => Math.random() - 0.5)
                .slice(0, 3)
                .map(w => currentMode === 'eng-chi' ? w.chinese : w.english);

            // Combine and shuffle answers
            currentAnswers = shuffleArray([correctAnswer, ...wrongAnswers]);
            correctAnswerIndex = currentAnswers.indexOf(correctAnswer);

            // Update answer buttons
            const buttons = document.querySelectorAll('.answer-btn');
            buttons.forEach((btn, index) => {
                btn.textContent = currentAnswers[index];
                btn.className = 'answer-btn';
                btn.disabled = false;
            });

            document.getElementById('feedback').textContent = '';
        }

        function checkAnswer(selectedIndex) {
            if (isAnswered) return;
            isAnswered = true;

            const buttons = document.querySelectorAll('.answer-btn');
            buttons.forEach(btn => btn.disabled = true);

            // Speak the selected answer if it's English (Mode B: Chinese ‚Üí English)
            if (currentMode === 'chi-eng') {
                speakWord(currentAnswers[selectedIndex]);
            }

            if (selectedIndex === correctAnswerIndex) {
                score++;
                document.getElementById('score').textContent = score;
                buttons[selectedIndex].classList.add('correct');
                document.getElementById('feedback').textContent = 'Correct! üéâ';
            } else {
                buttons[selectedIndex].classList.add('wrong');
                buttons[correctAnswerIndex].classList.add('correct');
                document.getElementById('feedback').textContent = 'Wrong ‚ùå';
            }

            document.getElementById('total').textContent = currentQuestionIndex + 1;

            // Load next question after delay
            setTimeout(() => {
                currentQuestionIndex++;
                loadQuestion();
            }, 1500);
        }

        function showResults() {
            document.getElementById('final-score').textContent = score;

            let message = '';
            const percentage = (score / totalQuestions) * 100;

            if (percentage === 100) {
                message = 'üèÜ Perfect! Â§™Ê£í‰∫ÜÔºÅYou are a vocabulary master!';
            } else if (percentage >= 80) {
                message = 'üåü Excellent! ÈùûÂ∏∏Â•ΩÔºÅKeep up the great work!';
            } else if (percentage >= 60) {
                message = 'üëç Good job! ‰∏çÈîôÔºÅKeep practicing!';
            } else if (percentage >= 40) {
                message = 'üí™ Keep trying! ÁªßÁª≠Âä™ÂäõÔºÅYou can do better!';
            } else {
                message = 'üìö Time to study! Âä†Ê≤πÂ≠¶‰π†ÔºÅPractice makes perfect!';
            }

            document.getElementById('result-message').textContent = message;
            showScreen('results-screen');
        }

        function restartQuiz() {
            startQuiz(currentMode);
        }

        // Flashcard functions
        function startFlashcards() {
            // Initialize speech on user interaction (button click)
            initSpeech();

            shuffledWords = shuffleArray(medicalWords);
            currentCardIndex = 0;
            document.getElementById('card-total').textContent = medicalWords.length;
            showScreen('flashcard-screen');
            updateFlashcard();
        }

        function updateFlashcard() {
            const card = shuffledWords[currentCardIndex];
            document.getElementById('card-front').textContent = card.english;
            document.getElementById('card-back').textContent = card.chinese;
            document.getElementById('card-index').textContent = currentCardIndex + 1;

            // Reset flip state
            document.getElementById('flashcard').classList.remove('flipped');
        }

        function flipCard() {
            const flashcard = document.getElementById('flashcard');
            const isCurrentlyFlipped = flashcard.classList.contains('flipped');

            // Speak the English word when clicking (before flipping to Chinese)
            if (!isCurrentlyFlipped) {
                speakWord(shuffledWords[currentCardIndex].english);
            }

            flashcard.classList.toggle('flipped');
        }

        function nextCard() {
            currentCardIndex = (currentCardIndex + 1) % shuffledWords.length;
            updateFlashcard();
        }

        function prevCard() {
            currentCardIndex = (currentCardIndex - 1 + shuffledWords.length) % shuffledWords.length;
            updateFlashcard();
        }

        function goHome() {
            showScreen('start-screen');
        }

        // ============================================
        // Paragraph Fill Game (Mode D)
        // ============================================

        // Medically coherent scenarios - each has a paragraph template with 3 specific related words
        // Words are chosen to make logical medical sense together
        const medicalScenarios = [
            {
                template: "A 55-year-old patient with uncontrolled {0} developed {1} in the left ventricle. The cardiologist ordered an {2} to evaluate cardiac function and wall motion abnormalities.",
                words: ["hypertension", "thrombosis", "electrocardiogram"]
            },
            {
                template: "The patient was admitted with severe {0} causing difficulty breathing. Chest X-ray revealed bilateral infiltrates consistent with {1}. The physician prescribed an {2} to treat the bacterial infection.",
                words: ["pneumonia", "inflammation", "antibiotic"]
            },
            {
                template: "Long-term {0} can damage blood vessels and lead to {1}. Regular monitoring of {2} levels is essential to prevent complications.",
                words: ["diabetes", "atherosclerosis", "glucose"]
            },
            {
                template: "The patient presented with joint pain and morning stiffness, suggesting {0}. Blood tests showed elevated markers of {1}. The rheumatologist started treatment to modulate the {2} response.",
                words: ["arthritis", "inflammation", "immune system"]
            },
            {
                template: "Chronic {0} resulted in scarring and development of {1}. The gastroenterologist recommended monitoring for signs of {2} in the esophagus.",
                words: ["hepatitis", "cirrhosis", "hemorrhage"]
            },
            {
                template: "The oncologist diagnosed the patient with {0} after bone marrow biopsy. Low {1} count put the patient at risk for {2}.",
                words: ["leukemia", "platelet", "hemorrhage"]
            },
            {
                template: "Untreated {0} can lead to kidney damage and {1}. The nephrologist recommended strict control of {2} to protect renal function.",
                words: ["hypertension", "nephritis", "blood pressure"]
            },
            {
                template: "The patient underwent {0} for tumor removal. Post-operative care included pain management with {1} and monitoring for signs of {2}.",
                words: ["surgery", "anesthesia", "infection"]
            },
            {
                template: "Severe {0} can trigger an asthma attack causing bronchospasm. The pulmonologist prescribed medication to reduce airway {1} and improve {2} function.",
                words: ["allergy", "inflammation", "respiratory"]
            },
            {
                template: "The patient's {0} showed abnormal rhythms indicating {1}. The cardiologist explained the {2} system was affected and recommended further evaluation.",
                words: ["electrocardiogram", "arrhythmia", "cardiovascular"]
            },
            {
                template: "Blood tests revealed low {0} levels causing {1}. The hematologist recommended iron supplementation to increase {2} production.",
                words: ["hemoglobin", "anemia", "erythrocyte"]
            },
            {
                template: "The elderly patient suffered a {0} after a fall, requiring surgical fixation. Bone density scan revealed severe {1}, increasing risk of future {2}.",
                words: ["fracture", "osteoporosis", "trauma"]
            },
            {
                template: "The patient developed a severe {0} reaction after taking the new medication. {1} was administered to treat the systemic response. The physician noted this in the patient's {2} history.",
                words: ["allergy", "injection", "immune system"]
            },
            {
                template: "Chronic {0} of the stomach lining led to development of an {1}. The gastroenterologist performed a {2} to examine the tissue.",
                words: ["gastritis", "ulcer", "biopsy"]
            },
            {
                template: "The patient with {0} required regular {1} to manage blood sugar levels. Poor metabolic control can affect {2} throughout the body.",
                words: ["diabetes", "insulin", "metabolism"]
            },
            {
                template: "The neurologist diagnosed {0} after the patient experienced recurrent seizures. An EEG showed abnormal electrical activity in the {1}. Medication was prescribed to stabilize the {2}.",
                words: ["epilepsy", "nerve", "nervous system"]
            },
            {
                template: "High {0} levels contributed to {1} of the coronary arteries. The cardiologist recommended lifestyle changes to improve {2} health.",
                words: ["cholesterol", "atherosclerosis", "cardiovascular"]
            },
            {
                template: "The patient received a {0} to prevent influenza infection. Vaccines work by stimulating the body's {1} to build protection. This enhances overall {2}.",
                words: ["vaccine", "immune system", "immunity"]
            },
            {
                template: "Abdominal imaging revealed a {0} on the liver requiring further investigation. The surgeon performed a {1} to determine if the growth was {2} or benign.",
                words: ["tumor", "biopsy", "malignant"]
            },
            {
                template: "The patient was diagnosed with {0} of the thyroid gland, causing weight gain and fatigue. Blood tests showed abnormal {1} levels affecting overall {2}.",
                words: ["hypothyroidism", "hormone", "metabolism"]
            },
            {
                template: "Inflammation of the {0} caused swelling in the legs. The vascular surgeon found a {1} blocking blood flow in the {2}.",
                words: ["vein", "thrombosis", "circulatory"]
            },
            {
                template: "The orthopedic surgeon repaired the torn {0} in the patient's knee. Post-surgery rehabilitation focused on strengthening the surrounding {1} and {2}.",
                words: ["ligament", "muscle", "cartilage"]
            },
            {
                template: "The patient presented with severe headache and neck stiffness, raising concern for {0}. A lumbar puncture confirmed {1} in the cerebrospinal fluid. Immediate {2} therapy was started.",
                words: ["meningitis", "infection", "antibiotic"]
            },
            {
                template: "Chronic kidney disease can cause {0} due to reduced production of erythropoietin. The nephrologist monitored {1} counts and treated the underlying {2}.",
                words: ["anemia", "erythrocyte", "nephritis"]
            },
            {
                template: "The patient's {0} revealed a suspicious mass in the abdomen. {1} imaging provided detailed pictures for the {2} to evaluate.",
                words: ["ultrasound", "MRI", "radiology"]
            },
            {
                template: "The pediatrician treated the child's ear {0} with appropriate medication. Recurring infections can lead to {1} of the middle ear and hearing problems. Parents were advised about {2} measures.",
                words: ["infection", "inflammation", "immunity"]
            },
            {
                template: "The patient with {0} disease experienced episodes of severe abdominal pain. Imaging showed {1} of the intestinal wall. A {2} was performed to assess tissue damage.",
                words: ["inflammatory", "inflammation", "biopsy"]
            },
            {
                template: "After the motor vehicle accident, the patient suffered a {0} and was monitored for neurological changes. CT scan ruled out {1}. The {2} team provided comprehensive care.",
                words: ["concussion", "hemorrhage", "neurology"]
            },
            {
                template: "The endocrinologist adjusted the patient's {0} dosage based on blood sugar readings. Proper {1} management is crucial in {2} care.",
                words: ["insulin", "dosage", "diabetes"]
            },
            {
                template: "The dermatologist identified {0} on the patient's skin caused by an autoimmune reaction. Topical treatment reduced the {1}. The condition is classified as {2}.",
                words: ["dermatitis", "inflammation", "autoimmune"]
            }
        ];

        // Paragraph game state
        let paragraphScore = 0;
        let currentBlanks = [];  // Array of {word, filled}
        let currentBlankIndex = 0;
        let selectedWords = [];
        let usedScenarioIndices = [];  // Track used scenarios to avoid repetition

        function startParagraph() {
            // Initialize speech on user interaction
            initSpeech();

            paragraphScore = 0;
            usedScenarioIndices = [];
            document.getElementById('para-score').textContent = '0';
            document.getElementById('para-feedback').textContent = '';
            document.getElementById('para-feedback').className = 'paragraph-feedback';

            showScreen('paragraph-screen');
            loadNewParagraph();
        }

        function loadNewParagraph() {
            // Reset state
            currentBlankIndex = 0;
            document.getElementById('para-feedback').textContent = '';
            document.getElementById('para-feedback').className = 'paragraph-feedback';

            // Select a random scenario that hasn't been used recently
            let availableIndices = [];
            for (let i = 0; i < medicalScenarios.length; i++) {
                if (!usedScenarioIndices.includes(i)) {
                    availableIndices.push(i);
                }
            }

            // If all scenarios used, reset the tracking
            if (availableIndices.length === 0) {
                usedScenarioIndices = [];
                availableIndices = medicalScenarios.map((_, i) => i);
            }

            // Pick a random available scenario
            const randomIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)];
            usedScenarioIndices.push(randomIndex);
            const scenario = medicalScenarios[randomIndex];

            // Set up the words for this scenario
            selectedWords = scenario.words.map(word => ({ english: word }));

            // Initialize blanks
            currentBlanks = scenario.words.map(word => ({
                word: word,
                filled: false
            }));

            // Build paragraph HTML with blanks
            let paragraphHTML = scenario.template;
            for (let i = 0; i < 3; i++) {
                paragraphHTML = paragraphHTML.replace(
                    `{${i}}`,
                    `<span class="blank ${i === 0 ? 'active' : ''}" data-index="${i}" id="blank-${i}">____</span>`
                );
            }

            document.getElementById('paragraph-text').innerHTML = paragraphHTML;

            // Create word choice buttons (shuffled order)
            const shuffledChoices = shuffleArray([...scenario.words]);
            const choicesHTML = shuffledChoices.map(word =>
                `<button class="word-btn" onclick="selectWord('${word}', this)">${word}</button>`
            ).join('');

            document.getElementById('word-choices').innerHTML = choicesHTML;
        }

        function selectWord(word, buttonElement) {
            const currentBlank = currentBlanks[currentBlankIndex];
            const blankElement = document.getElementById(`blank-${currentBlankIndex}`);

            if (word === currentBlank.word) {
                // Correct answer
                currentBlank.filled = true;
                blankElement.textContent = word;
                blankElement.classList.remove('active', 'wrong');
                blankElement.classList.add('filled');

                // Mark button as used
                buttonElement.classList.add('used');
                buttonElement.disabled = true;

                // Speak the word
                speakWord(word);

                // Move to next blank
                currentBlankIndex++;

                if (currentBlankIndex < 3) {
                    // Highlight next blank
                    const nextBlank = document.getElementById(`blank-${currentBlankIndex}`);
                    nextBlank.classList.add('active');
                } else {
                    // All blanks filled - success!
                    paragraphScore++;
                    document.getElementById('para-score').textContent = paragraphScore;

                    const feedback = document.getElementById('para-feedback');
                    feedback.textContent = 'Correct! üéâ Generating next paragraph...';
                    feedback.className = 'paragraph-feedback success';

                    // Load new paragraph after delay
                    setTimeout(() => {
                        loadNewParagraph();
                    }, 2000);
                }
            } else {
                // Wrong answer - shake animation
                blankElement.classList.add('wrong');
                setTimeout(() => {
                    blankElement.classList.remove('wrong');
                }, 500);
            }
        }
    </script>
</body>
</html>
